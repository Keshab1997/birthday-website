<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday My Love</title>
    <link rel="stylesheet" href="assets/css/global.css">
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

    <!-- Level 0: Lock Screen -->
    <div id="lock-screen"></div>

    <!-- Level 1: Hero Section -->
    <div id="hero-section" style="display:none;"></div>

    <!-- Level 2: Love Quiz -->
    <div id="quiz-section" style="display:none;"></div>

    <!-- Level 3: Memory Game -->
    <div id="memory-game-section" style="display:none;"></div>

    <!-- Level 4: Timeline -->
    <div id="timeline-section" style="display:none;"></div>

    <!-- Level 5: Gallery -->
    <div id="gallery-section" style="display:none;"></div>

    <!-- Level 6: Balloon Pop -->
    <div id="balloon-section" style="display:none;"></div>

    <!-- Level 7: Bucket List -->
    <div id="bucket-section" style="display:none;"></div>

    <!-- Level 7: Messages -->
    <div id="messages-section" style="display:none;"></div>

    <!-- Level 8: Virtual Gift -->
    <div id="gift-section" style="display:none;"></div>

    <!-- Level 9: Cake -->
    <div id="cake-section" style="display:none;"></div>

    <!-- Background Music -->
    <audio id="bg-music" loop>
        <source src="assets/music/romantic-track.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { _supabase } from './assets/js/supabase-config.js';
        
        // Make Supabase available globally for memory game
        window._supabase = _supabase;

        // Global Music Controller
        async function playMusicForLevel(levelNumber) {
            const audio = document.getElementById('bg-music');
            
            try {
                const { data, error } = await _supabase
                    .from('settings')
                    .select('value')
                    .eq('key', `music_level_${levelNumber}`)
                    .single();

                if (data && data.value) {
                    const newSrc = data.value;
                    if (!audio.src.endsWith(newSrc)) {
                        audio.src = newSrc;
                        audio.play().catch(err => console.log('Music autoplay blocked'));
                    }
                }
            } catch (err) {
                console.log('Music load error:', err);
            }
        }

        // Global functions for level navigation
        window.checkCode = async function() {
            const code = document.getElementById('secret-code').value;
            
            // Check code from database
            const { data } = await _supabase.from('settings').select('value').eq('key', 'secret_code').single();
            const correctCode = data?.value || '1205';
            
            if(code === correctCode) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('hero-section').style.display = 'block';
                document.getElementById('hero-section').classList.add('fade-in');
                playMusicForLevel(1);
            } else {
                alert('Wrong Code! Try again, Love. ðŸ’•');
            }
        };

        window.unlockMemoryGame = function() {
            document.getElementById('quiz-section').style.display = 'none';
            document.getElementById('memory-game-section').style.display = 'block';
            document.getElementById('memory-game-section').classList.add('fade-in');
            playMusicForLevel(3);
        };

        window.goToNextLevel = function() {
            document.getElementById('memory-game-section').style.display = 'none';
            document.getElementById('timeline-section').style.display = 'block';
            document.getElementById('timeline-section').classList.add('fade-in');
            playMusicForLevel(4);
        };

        window.unlockGallery = function() {
            document.getElementById('timeline-section').style.display = 'none';
            document.getElementById('gallery-section').style.display = 'block';
            document.getElementById('gallery-section').classList.add('fade-in');
            playMusicForLevel(5);
        };

        window.unlockBalloon = function() {
            document.getElementById('gallery-section').style.display = 'none';
            document.getElementById('balloon-section').style.display = 'block';
            document.getElementById('balloon-section').classList.add('fade-in');
            playMusicForLevel(6);
        };

        window.unlockBucket = function() {
            document.getElementById('balloon-section').style.display = 'none';
            document.getElementById('bucket-section').style.display = 'block';
            document.getElementById('bucket-section').classList.add('fade-in');
            playMusicForLevel(7);
        };

        window.unlockMessages = function() {
            document.getElementById('bucket-section').style.display = 'none';
            document.getElementById('messages-section').style.display = 'block';
            document.getElementById('messages-section').classList.add('fade-in');
            playMusicForLevel(8);
        };

        window.unlockGift = function() {
            document.getElementById('messages-section').style.display = 'none';
            document.getElementById('gift-section').style.display = 'block';
            document.getElementById('gift-section').classList.add('fade-in');
            playMusicForLevel(9);
        };

        window.unlockCake = function() {
            document.getElementById('gift-section').style.display = 'none';
            document.getElementById('cake-section').style.display = 'block';
            document.getElementById('cake-section').classList.add('fade-in');
            playMusicForLevel(10);
        };

        async function loadSection(id, path) {
            try {
                const response = await fetch(path);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
                
                // Load corresponding JS modules
                if (id === 'hero-section') {
                    import('./sections/01-hero/hero.js');
                }
                if (id === 'quiz-section') {
                    const script = document.createElement('script');
                    script.src = 'sections/07-quiz/quiz.js';
                    document.body.appendChild(script);
                }
                if (id === 'memory-game-section') {
                    const script = document.createElement('script');
                    script.src = 'sections/06-memory-game/memory-game.js';
                    document.body.appendChild(script);
                }
                if (id === 'timeline-section') {
                    import('./sections/02-timeline/timeline.js');
                }
                if (id === 'gallery-section') {
                    import('./sections/03-gallery/gallery.js');
                }
                if (id === 'balloon-section') {
                    const script = document.createElement('script');
                    script.src = 'sections/10-balloons/balloons.js';
                    document.body.appendChild(script);
                }
                if (id === 'bucket-section') {
                    const script = document.createElement('script');
                    script.src = 'sections/08-bucket/bucket.js';
                    document.body.appendChild(script);
                }
                if (id === 'messages-section') {
                    import('./sections/04-messages/messages.js');
                }
                if (id === 'gift-section') {
                    const script = document.createElement('script');
                    script.src = 'sections/09-gift/gift.js';
                    document.body.appendChild(script);
                }
            } catch (err) {
                console.error('Error loading section:', err);
            }
        }

        // Load all sections on page load
        window.onload = () => {
            loadSection('lock-screen', 'sections/00-lock/lock.html');
            loadSection('hero-section', 'sections/01-hero/hero.html');
            loadSection('quiz-section', 'sections/07-quiz/quiz.html');
            loadSection('memory-game-section', 'sections/06-memory-game/memory-game.html');
            loadSection('timeline-section', 'sections/02-timeline/timeline.html');
            loadSection('gallery-section', 'sections/03-gallery/gallery.html');
            loadSection('balloon-section', 'sections/10-balloons/balloons.html');
            loadSection('bucket-section', 'sections/08-bucket/bucket.html');
            loadSection('messages-section', 'sections/04-messages/messages.html');
            loadSection('gift-section', 'sections/09-gift/gift.html');
            loadSection('cake-section', 'sections/05-cake/cake.html');
            
            // Start with lock screen music
            playMusicForLevel(0);
        };

        // Start background music on first user interaction
        document.body.addEventListener('click', () => {
            const music = document.getElementById('bg-music');
            if(music.paused) music.play();
        }, { once: true });
    </script>
</body>
</html>
