<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Happy Birthday My Love</title>
    <link rel="stylesheet" href="assets/css/global.css">
    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>
    <!-- Preloader -->
    <div id="preloader">
        <div class="heart-loader"></div>
        <p style="color: #ff4081; margin-top: 20px; font-size: 18px;">Loading Love... ðŸ’•</p>
    </div>

    <!-- Level 0: Lock Screen -->
    <div id="lock-screen"></div>

    <!-- Level 1: Hero Section -->
    <div id="hero-section" style="display:none;"></div>

    <!-- Level 2: Love Quiz -->
    <div id="quiz-section" style="display:none;"></div>

    <!-- Level 3: Memory Game -->
    <div id="memory-game-section" style="display:none;"></div>

    <!-- Level 4: Timeline -->
    <div id="timeline-section" style="display:none;"></div>

    <!-- Level 5: Gallery -->
    <div id="gallery-section" style="display:none;"></div>

    <!-- Level 6: Balloon Pop -->
    <div id="balloon-section" style="display:none;"></div>

    <!-- Level 7: Scratch Card -->
    <div id="scratch-section" style="display:none;"></div>

    <!-- Level 8: Spin Wheel -->
    <div id="wheel-section" style="display:none;"></div>

    <!-- Level 9: A-Z Love -->
    <div id="az-section" style="display:none;"></div>

    <!-- Level 10: Bucket List -->
    <div id="bucket-section" style="display:none;"></div>

    <!-- Level 11: Messages -->
    <div id="messages-section" style="display:none;"></div>

    <!-- Level 12: Virtual Gift -->
    <div id="gift-section" style="display:none;"></div>

    <!-- Level 13: Cake -->
    <div id="cake-section" style="display:none;"></div>

    <!-- Background Music -->
    <audio id="bg-music" loop>
        <source src="assets/music/romantic-track.mp3" type="audio/mpeg">
    </audio>

    <script type="module">
        import { _supabase } from './assets/js/supabase-config.js';
        window._supabase = _supabase;
        
        // Wait for Supabase to be ready
        let supabaseReady = false;
        const supabaseReadyPromise = new Promise(resolve => {
            if (window._supabase) {
                supabaseReady = true;
                resolve();
            }
        });

        // Button click sound
        const buttonClickSound = new Audio('assets/sounds/button-click.mp3');
        
        // Add click sound to all buttons
        document.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.classList.contains('next-btn') || e.target.classList.contains('skip-btn')) {
                buttonClickSound.currentTime = 0;
                buttonClickSound.play().catch(() => {});
            }
        });

        // Unified Level Controller
        window.goToLevel = function(levelNumber) {
            const levels = [
                'lock-screen', 'hero-section', 'quiz-section', 'memory-game-section', 
                'timeline-section', 'gallery-section', 'balloon-section', 'scratch-section',
                'wheel-section', 'az-section', 'bucket-section', 'messages-section', 
                'gift-section', 'cake-section'
            ];

            document.querySelectorAll('body > div[id]').forEach(div => {
                if(div.id !== 'bg-music') div.style.display = 'none';
            });

            const targetId = levels[levelNumber];
            const targetEl = document.getElementById(targetId);
            if(targetEl) {
                targetEl.style.display = 'block';
                targetEl.classList.add('fade-in');
                window.scrollTo(0, 0);
                playMusicForLevel(levelNumber);
            }
        };

        // Music Controller with Fade Effect
        async function playMusicForLevel(levelNumber) {
            // Wait for Supabase to be ready
            if (!supabaseReady) {
                await supabaseReadyPromise;
            }
            
            const audio = document.getElementById('bg-music');
            try {
                const { data } = await _supabase.from('settings').select('value').eq('key', `music_level_${levelNumber}`).maybeSingle();
                if (data && data.value && !audio.src.includes(data.value)) {
                    // Fade out current music
                    fadeOutMusic(audio, () => {
                        // Change source and fade in new music
                        audio.src = data.value;
                        audio.play().catch(() => console.log('Music blocked'));
                        fadeInMusic(audio);
                    });
                }
            } catch (err) {
                console.log('Music error:', err);
            }
        }
        
        // Fade out music
        function fadeOutMusic(audio, callback) {
            const fadeInterval = setInterval(() => {
                if (audio.volume > 0.1) {
                    audio.volume = Math.max(0, audio.volume - 0.1);
                } else {
                    clearInterval(fadeInterval);
                    audio.pause();
                    audio.volume = 1;
                    if (callback) callback();
                }
            }, 100);
        }
        
        // Fade in music
        function fadeInMusic(audio) {
            audio.volume = 0;
            const fadeInterval = setInterval(() => {
                if (audio.volume < 0.9) {
                    audio.volume = Math.min(1, audio.volume + 0.1);
                } else {
                    clearInterval(fadeInterval);
                    audio.volume = 1;
                }
            }, 100);
        }

        // Check Code Function
        window.checkCode = async function() {
            // Wait for Supabase to be ready
            if (!supabaseReady) {
                await supabaseReadyPromise;
            }
            
            const code = document.getElementById('secret-code').value;
            const { data } = await _supabase.from('settings').select('value').eq('key', 'secret_code').maybeSingle();
            const correctCode = data?.value || '1205';
            
            if(code === correctCode) {
                goToLevel(1);
            } else {
                alert('Wrong Code! Try again, Love. ðŸ’•');
            }
        };

        // Section Loader
        async function loadSection(id, path, scriptPath = null) {
            try {
                const response = await fetch(path);
                const html = await response.text();
                document.getElementById(id).innerHTML = html;
                
                if (scriptPath) {
                    const script = document.createElement('script');
                    script.src = scriptPath;
                    document.body.appendChild(script);
                }
            } catch (err) {
                console.error('Error loading:', id, err);
            }
        }

        window.onload = async () => {
            await loadSection('lock-screen', 'sections/00-lock/lock.html');
            await loadSection('hero-section', 'sections/01-hero/hero.html', './sections/01-hero/hero.js');
            await loadSection('quiz-section', 'sections/07-quiz/quiz.html', './sections/07-quiz/quiz.js');
            await loadSection('memory-game-section', 'sections/06-memory-game/memory-game.html', './sections/06-memory-game/memory-game.js');
            await loadSection('timeline-section', 'sections/02-timeline/timeline.html', './sections/02-timeline/timeline.js');
            await loadSection('gallery-section', 'sections/03-gallery/gallery.html', './sections/03-gallery/gallery.js');
            await loadSection('balloon-section', 'sections/10-balloons/balloons.html', './sections/10-balloons/balloons.js');
            await loadSection('scratch-section', 'sections/11-scratch/scratch.html', './sections/11-scratch/scratch.js');
            await loadSection('wheel-section', 'sections/12-wheel/wheel.html', './sections/12-wheel/wheel.js');
            await loadSection('az-section', 'sections/13-az/az.html', './sections/13-az/az.js');
            await loadSection('bucket-section', 'sections/08-bucket/bucket.html', './sections/08-bucket/bucket.js');
            await loadSection('messages-section', 'sections/04-messages/messages.html', './sections/04-messages/messages.js');
            await loadSection('gift-section', 'sections/09-gift/gift.html', './sections/09-gift/gift.js');
            await loadSection('cake-section', 'sections/05-cake/cake.html');
            
            document.getElementById('preloader').style.display = 'none';
            goToLevel(0);
        };

        document.body.addEventListener('click', () => {
            const music = document.getElementById('bg-music');
            if(music.paused) music.play();
        }, { once: true });
    </script>
</body>
</html>
